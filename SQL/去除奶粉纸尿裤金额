/*
  主要是去除奶粉纸尿裤的商品编码, 而后相加 
  我老是记得有一个字段,直接可以sum 就是本金额的. 不知道去哪里了.不用这么麻烦算的

*/


SELECT
	gs.salesdepart_id,
	ROUND(
		(
			SUM(
				gsd.deal_price * gsd.sales_number
			) - IFNULL(SUM(gsp.gift_balance), 0)
		) / 10000,
		2
	) AS amount
FROM
	(
		SELECT
			salesdepart_id,
			id
		FROM
			arm_changsha.goods_sales  AS gds
		WHERE
		sales_date 
		BETWEEN "2019-03-01 00:00:00"
		AND "2019-03-31 23:59:59"
	) AS gs
LEFT JOIN arm_changsha.goods_sales_detail AS gsd ON gsd.sales_id = gs.id
LEFT JOIN arm_changsha.goods_sales_pay_detail gsp ON  CONCAT(gsp.sales_id,'_',gsp.goods_id) = CONCAT(gs.id, '_', gsd.goods_id)
WHERE gsd.barcode NOT IN (
            SELECT
                条码
            FROM
                `tmp_通货`
            )
-- AND gs.salesdepart_id = "1001"
GROUP BY gs.salesdepart_id


